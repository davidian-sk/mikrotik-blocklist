# **🛡️ Davidian-SK MikroTik Blocklist Aggregator**

This repository provides a self-updating, high-performance MikroTik Address List generated by aggregating multiple public threat intelligence feeds. The core goal is to generate the mathematically **most compact set of CIDR ranges** possible, minimizing clutter and maximizing firewall efficiency on devices like the MikroTik RB5009.

## **🚀 Features**

* **Source Aggregation:** Pulls IP data from various public threat feeds (sources.txt).  
* **Optimal Compression:** Uses the Python ipaddress library to aggregate thousands of individual IPs and ranges (like /22, /17) into the **minimal list of CIDR blocks**.  
* **High Performance:** Generates a RouterOS script (blocklist.rsc) designed for import into the **raw** firewall table.  
* **Dual Automation:** Includes two scripts for flexible deployment (local host or GitHub-driven).

## **📝 Output Files**

The Linux script generates the following files:

| File Name | Content | Purpose |
| :---- | :---- | :---- |
| **blocklist.rsc** | RouterOS script for import. | **Essential:** This is what the MikroTik downloads and runs. |
| **aggregated\_cidr\_ranges.txt** | List of final, optimized IP/CIDR ranges (e.g., 1.2.3.0/24). | **Essential:** Used for direct audit or consumption by other tools. |
| **aggregated\_ips.txt** | List of unique, non-compressed IPs/Ranges. | **Audit Log:** Used for debugging and tracing false positives. |
| **ip\_aggregator\_git.sh** | The script that generated the files. | **Source Control:** Tracks the logic used for the push. |
| **sources.txt** | List of all input URLs. | **Configuration:** Tracks the source feeds used. |

## **🛠️ Automation Setup**

This setup assumes the aggregation script runs on a Linux host (e.g., your **Raspberry Pi 5** running a daily cron job) and the MikroTik fetches the result from this repository on a weekly schedule.

# **1. Host Setup (Linux Cron Job)**

Choose one of the two aggregator scripts to run based on your needs:

| Script Name | Use Case | Frequency |
| :---- | :---- | :---- |
| **ip\_aggregator\_local.sh** | **Daily Runs** (Fastest local update). | Recommended: **Daily** (e.g., 03:00) |
| **ip\_aggregator\_git.sh** | **GitHub Push** (For public repository updates). | Recommended: **Weekly** (e.g., Sunday @ 03:00) |

To run the script daily using cron (e.g., for the local version):

**Edit the cron schedule:**
```bash
crontab -e
```

**Add this line to run the script every day at 3:00 AM (Ensure path is correct\!):**
```bash
0 3 * * * /path/to/project/ip_aggregator_local.sh
```

#  2. MikroTik RouterOS Scheduler 

This method uses your custom script logic, which saves the file to the reliable USB mount (usb2/blocklist/) and includes robust file size verification to prevent importing corrupted data.


To set up the scripts and the scheduler, use the following commands on your MikroTik terminal:



### I. SCRIPT DEFINITIONS (Download and Replace Logic)

```routeros
/system script

# Script to remove the old list and import the new data (davidian-sk-blocklist-replace)
add name="davidian-sk-blocklist-replace" source={
    :log info "Importing new threat feed and cleaning old list."
    /ip firewall address-list remove [find where list="davidian-sk-blocklist"];
    /import file-name=usb2/blocklist/blocklist.rsc;
    /file remove usb2/blocklist/blocklist.rsc
    :log info "Threat list imported and files cleaned."
}

# Script to download the latest blocklist from GitHub (davidian-sk-blocklist-dl)
add name="davidian-sk-blocklist-dl" source={
    :log info "Starting threat feed download from GitHub."
    /tool fetch url="https://raw.githubusercontent.com/davidian-sk/mikrotik-blocklist/main/blocklist.rsc" mode=https dst-path=usb2/blocklist/blocklist.rsc verify-certificate=yes

    # Verify the file exists and has non-zero size
    :local f [/file find name="usb2/blocklist/blocklist.rsc"]
    :if ([:len $f] > 0) do={
        :local size [/file get $f size]
        :if ($size > 0) do={
            :log info "File downloaded successfully ($size bytes). Running import script."
            /system script run davidian-sk-blocklist-replace
        } else={
            :log error "File exists but is empty. Aborting import."
        }
    } else={
        :log error "File download failed or not found."
    }
}
```

### II. SCHEDULER SETUP (Weekly Run)

```routeros
/system scheduler
add interval=7d name="dl-ins-mt-blocklist" start-time=00:05:00 on-event=davidian-sk-blocklist-dl comment="Weekly update for GitHub threat blocklist"
```


# **3\. Add Firewall Rule (Router OS)**


### **Option A: *(Recommended Method)* High-Performance Raw Rule (for Large Lists)**

This drops incoming traffic destined for devices behind your router using the most efficient table.
This is the most efficient method. This rule runs before connection tracking, which is highly efficient and saves CPU cycles on your router.
Add the firewall rule to your raw table to drop all incoming traffic from sources in your new address list. 

```routeros
/ip firewall raw
add action=drop chain=input src-address-list=davidian-sk-blocklist comment="Drop traffic from Davidian-SK Blocklist"
```
### **Option B: Standard Filter Rule**

While using the raw table is recommended for the best performance, you can also use this blocklist with the classic firewall filter rules.
Important Note on CPU Usage: The primary difference is that filter rules are processed after connection tracking. 
This means every packet from a new connection will be checked against the address list, resulting in a higher CPU load. 
On a powerful device like the RB5009, this may be negligible, but on less powerful routers, it could significantly impact performance.

*If you prefer to use the standard filter chain instead:*

**Protect your router itself (input chain):**

```routeros
/ip firewall filter
add action=drop chain=input src-address-list=davidian-sk-blocklist comment="Drop traffic from Davidian-SK Blocklist"
```

**Protect your LAN clients (forward chain):**

```routeros
/ip firewall filter
add action=drop chain=forward src-address-list=davidian-sk-blocklist comment="Drop traffic from Davidian-SK Blocklist"
```

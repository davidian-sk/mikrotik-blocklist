# **🛡️ Davidian-SK MikroTik Blocklist Aggregator**

This repository provides a self-updating, high-performance MikroTik Address List generated by aggregating multiple public threat intelligence feeds. The core goal is to generate the mathematically **most compact set of CIDR ranges** possible, minimizing clutter and maximizing firewall efficiency on devices like the MikroTik RB5009.

## **🚀 Features**

* **Source Aggregation:** Pulls IP data from various public threat feeds (sources.txt).  
* **Optimal Compression:** Uses the Python ipaddress library to aggregate thousands of individual IPs and ranges (like /22, /17) into the **minimal list of CIDR blocks**.  
* **High Performance:** Generates a RouterOS script (blacklist.rsc) designed for import into the **raw** firewall table.  
* **Dual Automation:** Includes two scripts for flexible deployment (local host or GitHub-driven).

## **📝 Output Files**

The Linux script generates the following files:

| File Name | Content | Purpose |
| :---- | :---- | :---- |
| **blacklist.rsc** | RouterOS script for import. | **Essential:** This is what the MikroTik downloads and runs. |
| **aggregated\_cidr\_ranges.txt** | List of final, optimized IP/CIDR ranges (e.g., 1.2.3.0/24). | **Essential:** Used for direct audit or consumption by other tools. |
| **aggregated\_ips.txt** | List of unique, non-compressed IPs/Ranges. | **Audit Log:** Used for debugging and tracing false positives. |
| **ip\_aggregator\_git.sh** | The script that generated the files. | **Source Control:** Tracks the logic used for the push. |
| **sources.txt** | List of all input URLs. | **Configuration:** Tracks the source feeds used. |

## **🛠️ Automation Setup**

This setup assumes the aggregation script runs on a Linux host (e.g., your **Raspberry Pi 5** running a daily cron job) and the MikroTik fetches the result from this repository on a weekly schedule.

### **1\. Host Setup (Linux Cron Job)**

Choose one of the two aggregator scripts to run based on your needs:

| Script Name | Use Case | Frequency |
| :---- | :---- | :---- |
| **ip\_aggregator\_local.sh** | **Daily Runs** (Fastest local update). | Recommended: **Daily** (e.g., 03:00) |
| **ip\_aggregator\_git.sh** | **GitHub Push** (For public repository updates). | Recommended: **Weekly** (e.g., Sunday @ 03:00) |

To run the script daily using cron (e.g., for the local version):

\# Edit the cron schedule  
crontab \-e

\# Add this line to run the script every day at 3:00 AM (Ensure path is correct\!)  
0 3 \* \* \* /path/to/project/ip\_aggregator\_local.sh

### **2\. MikroTik RouterOS Scheduler (The Foolproof Method)**

This method uses your custom script logic, which saves the file to the reliable USB mount (usb2/blacklist/) and includes robust file size verification to prevent importing corrupted data.

Run the following commands on your **MikroTik terminal** (or import the single install-mt-scripts.rsc file) to define the two scripts and the weekly scheduler:

/system script  
\# Script to remove the old list and import the new data (MUST BE DEFINED FIRST)  
add name="davidian-sk-blacklist-replace" source={  
    :log info "Importing new threat feed and cleaning old list."  
    /ip firewall address-list remove \[find where list="davidian-sk-blocklist"\];   
    /import file-name=usb2/blacklist/blacklist.rsc;   
    /file remove usb2/blacklist/blacklist.rsc  
    :log info "Threat list imported and files cleaned."  
}

\# Script to download the latest blocklist from GitHub to the USB mount  
add name="davidian-sk-blacklist-dl" source={  
    :log info "Starting threat feed download from GitHub."  
    /tool fetch url="\[https://raw.githubusercontent.com/davidian-sk/mikrotik-blocklist/main/blacklist.rsc\](https://raw.githubusercontent.com/davidian-sk/mikrotik-blocklist/main/blacklist.rsc)" mode=https dst-path=usb2/blacklist/blacklist.rsc verify-certificate=yes  
      
    \# Verify the file exists and has non-zero size  
    :local f \[/file find name="usb2/blacklist/blacklist.rsc"\]  
    :if (\[:len $f\] \> 0\) do={  
        :local size \[/file get $f size\]  
        :if ($size \> 0\) do={  
            :log info "File downloaded successfully ($size bytes). Running import script."  
            /system script run davidian-sk-blacklist-replace  
        } else={  
            :log error "File exists but is empty. Aborting import."  
        }  
    } else={  
        :log error "File download failed or not found."  
    }  
}

/system scheduler  
\# Schedule the download and import process to run once a week  
add interval=7d name="dl-ins-mt-blacklist" start-time=00:05:00 on-event=davidian-sk-blacklist-dl comment="Weekly update for GitHub threat blocklist"  
